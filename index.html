<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ハングル・完全分解ビルダー</title>
    <style>
        :root {
            --cho-c: #ffab19; --jung-c: #4cbf39; --jong-c: #4ca5ff;
            --slot-bg: #f0f0f0;
        }
        body { font-family: sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 10px; }
        
        /* コントロールパネル */
        .controls { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; width: 900px; display: flex; gap: 20px; justify-content: center; }
        .control-group { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .label { font-weight: bold; font-size: 12px; color: #777; }
        .btn-mini { padding: 5px 12px; border: 1px solid #ddd; background: #fff; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .btn-mini.active { background: #333; color: white; border-color: #333; }

        .main-layout { display: flex; gap: 15px; width: 950px; height: 700px; }

        /* パレット */
        .palette { width: 220px; background: white; border-radius: 15px; padding: 15px; overflow-y: auto; border: 1px solid #ddd; }
        .section-title { font-size: 11px; font-weight: bold; color: #888; margin: 10px 0 5px; border-bottom: 1px solid #eee; }
        .block-grid { display: flex; flex-wrap: wrap; gap: 5px; }
        .draggable-block {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            border-radius: 6px; color: white; font-weight: bold; cursor: grab; font-size: 16px;
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }

        /* ワークスペース */
        .workspace { flex: 1; background: #fff; border-radius: 15px; padding: 20px; display: flex; flex-direction: column; align-items: center; border: 1px solid #ddd; }
        .preview-area { font-size: 120px; height: 150px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; font-family: "Malgun Gothic", sans-serif; }
        
        .drop-zone-container { 
            min-height: 120px; display: flex; flex-direction: column; gap: 10px;
            background: #fafafa; border-radius: 15px; width: 100%; padding: 20px; border: 2px inset #eee;
        }
        .row { display: flex; justify-content: center; gap: 10px; align-items: center; }
        .row-label { width: 50px; font-size: 12px; color: #999; font-weight: bold; }
        
        .slot {
            width: 55px; height: 55px; border-radius: 10px; background: var(--slot-bg);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: #ccc; font-weight: bold; border: 2px dashed #ccc;
        }
        .slot.drag-over { border-color: #666; background: #e0e0e0; }
        .slot.filled { border-style: solid; color: white; }

        #final-string { font-size: 36px; min-height: 50px; border-bottom: 2px solid #eee; margin: 15px 0; width: 100%; text-align: center; }
        .btn-group { display: flex; gap: 8px; width: 100%; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="controls">
    <div class="control-group">
        <span class="label">初声スロット</span>
        <div>
            <button class="btn-mini active" onclick="setCount('cho', 1)">1</button>
            <button class="btn-mini" onclick="setCount('cho', 2)">2</button>
        </div>
    </div>
    <div class="control-group">
        <span class="label">中声スロット</span>
        <div>
            <button class="btn-mini active" onclick="setCount('jung', 1)">1</button>
            <button class="btn-mini" onclick="setCount('jung', 2)">2</button>
            <button class="btn-mini" onclick="setCount('jung', 3)">3</button>
        </div>
    </div>
    <div class="control-group">
        <span class="label">終声スロット</span>
        <div>
            <button class="btn-mini active" onclick="setCount('jong', 0)">0</button>
            <button class="btn-mini" onclick="setCount('jong', 1)">1</button>
            <button class="btn-mini" onclick="setCount('jong', 2)">2</button>
        </div>
    </div>
</div>

<div class="main-layout">
    <div class="palette">
        <div class="section-title">基本子音</div>
        <div id="cho-p" class="block-grid"></div>
        <div class="section-title">基本母音</div>
        <div id="jung-p" class="block-grid"></div>
    </div>

    <div class="workspace">
        <div class="preview-area" id="result-display">?</div>
        <div class="drop-zone-container" id="drop-zone"></div>
        <div id="final-string"></div>
        <div class="btn-group">
            <button class="btn" style="background: #4caf50;" onclick="addToOutput()">確定</button>
            <button class="btn" style="background: #2196f3;" onclick="speak()">再生</button>
            <button class="btn" style="background: #ff5252;" onclick="clearAll()">リセット</button>
        </div>
    </div>
</div>

<script>
const BASE_CHO = ["ㄱ","ㄴ","ㄷ","ㄹ","ㅁ","ㅂ","ㅅ","ㅇ","ㅈ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"];
const BASE_JUNG = ["ㅏ","ㅐ","ㅑ","ㅒ","ㅓ","ㅔ","ㅕ","ㅖ","ㅗ","ㅛ","ㅜ","ㅠ","ㅡ","ㅣ"];

// 合成辞書
const MAP_CHO = {"ㄱ":0,"ㄲ":1,"ㄴ":2,"ㄷ":3,"ㄸ":4,"ㄹ":5,"ㅁ":6,"ㅂ":7,"ㅃ":8,"ㅅ":9,"ㅆ":10,"ㅇ":11,"ㅈ":12,"ㅉ":13,"ㅊ":14,"ㅋ":15,"ㅌ":16,"ㅍ":17,"ㅎ":18};
const MAP_JUNG = {"ㅏ":0,"ㅐ":1,"ㅑ":2,"ㅒ":3,"ㅓ":4,"ㅔ":5,"ㅕ":6,"ㅖ":7,"ㅗ":8,"ㅘ":9,"ㅙ":10,"ㅚ":11,"ㅛ":12,"ㅜ":13,"ㅝ":14,"ㅞ":15,"ㅟ":16,"ㅠ":17,"ㅡ":18,"ㅢ":19,"ㅣ":20};
const MAP_JONG = {"ㄱ":1,"ㄲ":2,"ㄳ":3,"ㄴ":4,"ㄵ":5,"ㄶ":6,"ㄷ":7,"ㄹ":8,"ㄺ":9,"ㄻ":10,"ㄼ":11,"ㄽ":12,"ㄾ":13,"ㄿ":14,"ㅀ":15,"ㅁ":16,"ㅂ":17,"ㅄ":18,"ㅅ":19,"ㅆ":20,"ㅇ":21,"ㅈ":22,"ㅊ":23,"ㅋ":24,"ㅌ":25,"ㅍ":26,"ㅎ":27};

const COMBO_CHO = { "ㄱㄱ":"ㄲ", "ㄷㄷ":"ㄸ", "ㅂㅂ":"ㅃ", "ㅅㅅ":"ㅆ", "ㅈㅈ":"ㅉ" };
const COMBO_JUNG = { "ㅗㅏ":9, "ㅗㅐ":10, "ㅗㅣ":11, "ㅜㅓ":14, "ㅜㅔ":15, "ㅜㅣ":16, "ㅡㅣ":19 };
const COMBO_JONG = { "ㄱㄱ":2, "ㄱㅅ":3, "ㄴㅈ":5, "ㄴㅎ":6, "ㄹㄱ":9, "ㄹㅁ":10, "ㄹㅂ":11, "ㄹㅅ":12, "ㄹㅌ":13, "ㄹㅍ":14, "ㄹㅎ":15, "ㅂㅅ":18, "ㅅㅅ":20 };

let counts = { cho: 1, jung: 1, jong: 0 };
let slots = { cho: [], jung: [], jong: [] };
let fullText = "";

function init() {
    renderPalette('cho-p', BASE_CHO, 'cho', '#ffab19');
    renderPalette('jung-p', BASE_JUNG, 'jung', '#4cbf39');
    refreshWorkspace();
}

function renderPalette(id, list, type, color) {
    const container = document.getElementById(id);
    list.forEach(char => {
        const b = document.createElement('div');
        b.className = 'draggable-block';
        b.style.backgroundColor = color;
        b.innerText = char;
        b.draggable = true;
        b.ondragstart = (e) => { e.dataTransfer.setData('char', char); e.dataTransfer.setData('type', type); };
        container.appendChild(b);
    });
}

function setCount(type, n) {
    counts[type] = n;
    // UI更新
    const btns = event.target.parentNode.querySelectorAll('.btn-mini');
    btns.forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    refreshWorkspace();
}

function refreshWorkspace() {
    const container = document.getElementById('drop-zone');
    container.innerHTML = '';
    slots = { cho: Array(counts.cho).fill(''), jung: Array(counts.jung).fill(''), jong: Array(counts.jong).fill('') };

    ['cho', 'jung', 'jong'].forEach(type => {
        if(counts[type] === 0) return;
        const row = document.createElement('div');
        row.className = 'row';
        const label = document.createElement('div');
        label.className = 'row-label';
        label.innerText = type.toUpperCase();
        row.appendChild(label);

        for(let i=0; i<counts[type]; i++) {
            const s = document.createElement('div');
            s.className = 'slot';
            s.innerText = '+';
            s.ondragover = (e) => { e.preventDefault(); s.classList.add('drag-over'); };
            s.ondragleave = () => s.classList.remove('drag-over');
            s.ondrop = (e) => {
                e.preventDefault();
                const char = e.dataTransfer.getData('char');
                const bType = e.dataTransfer.getData('type');
                // 初声と終声はどちらも子音ブロックを受け入れる
                if((type === 'cho' || type === 'jong') && bType === 'cho' || (type === 'jung' && bType === 'jung')) {
                    slots[type][i] = char;
                    s.innerText = char;
                    s.classList.add('filled');
                    s.style.backgroundColor = bType === 'cho' ? (type==='cho'?'#ffab19':'#4ca5ff') : '#4cbf39';
                    updateResult();
                }
            };
            row.appendChild(s);
        }
        container.appendChild(row);
    });
    updateResult();
}

function updateResult() {
    // 合成ロジック
    let choStr = slots.cho.join('');
    let choChar = COMBO_CHO[choStr] || slots.cho[0] || 'ㅇ';
    let choIdx = MAP_CHO[choChar] ?? 11;

    let jungStr = slots.jung.join('');
    let jungIdx = COMBO_JUNG[jungStr] ?? MAP_JUNG[slots.jung[0]] ?? 0;
    // 3文字合成(例: ㅞ)の簡易対応
    if(jungStr === "ㅜㅓㅣ") jungIdx = 15;

    let jongStr = slots.jong.join('');
    let jongIdx = COMBO_JONG[jongStr] ?? MAP_JONG[slots.jong[0]] ?? 0;

    const code = (choIdx * 588) + (jungIdx * 28) + jongIdx + 44032;
    document.getElementById('result-display').innerText = String.fromCharCode(code);
}

function addToOutput() {
    fullText += document.getElementById('result-display').innerText;
    document.getElementById('final-string').innerText = fullText;
}

function clearAll() { fullText = ""; document.getElementById('final-string').innerText = ""; refreshWorkspace(); }

function speak() {
    const u = new SpeechSynthesisUtterance(fullText || document.getElementById('result-display').innerText);
    u.lang = 'ko-KR';
    window.speechSynthesis.speak(u);
}

init();
</script>
</body>
</html>
